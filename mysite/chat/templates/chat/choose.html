<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script type="text/javascript">//<![CDATA[
    console.log(1231);
    connect();
    function connect() {
        if(window.s){
            window.s.close()
        }
        var a = document.getElementById('toWhom');
        var text = 0;
        if (a !== null) {
            text = Number(a.val());
        }

        var s = new WebSocket("ws://" + window.location.host + "/chat/connect/" + text);
        s.onopen = function () {
            console.log('WebSocket open');
        };
        s.onmessage = function (e) {
            console.log('message: ' + e.data);
            $('#messagecontainer').prepend('<p>' + e.data + '</p>');
        };
        window.s = s;
        console.log(window.s);
    }


    $(function () {
        $('#send_message').click(function () {
            if(!window.s){
                alert("Please connect server.");
            }else{
                window.s.send($('#message').val());
            }
        });
        $('#close_websocket').click(function () {
            if(window.s){
                window.s.close();
            }
        });
        $('#message').bind('input propertychange', function() {
        });
    });
    </script>

</head>
<body>
    {% for i in on_line %}
        <form action="{% url 'chat' %}" method="POST">
        <button type="submit" name="towhom" value="{{ i.id }}">{{ i.username }}</button>
        {% csrf_token %}
        </form>
    {% endfor %}
</body>
</html>